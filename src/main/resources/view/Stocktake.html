<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Stocktake Window</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#c71551",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211116",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .scrollbar-default::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .scrollbar-default::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .scrollbar-default::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        .scrollbar-default::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display h-screen flex flex-col overflow-hidden">
    <div
        class="flex items-center justify-between px-8 py-6 border-b border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#2a1d21]">
        <div class="flex flex-col gap-1">
            <h1 class="text-[#181113] dark:text-white text-2xl font-bold leading-tight">Kiểm Kê Tài Sản</h1>
            <p class="text-[#88636f] dark:text-[#bcaaa5] text-sm font-normal">Ghi nhận số lượng thực tế và đối chiếu
                chênh lệch.</p>
        </div>
    </div>
    <div class="flex-1 overflow-y-auto custom-scrollbar bg-[#f8fafc] p-8">
        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm mb-8">
            <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-2">
                <span class="material-symbols-outlined text-gray-400 text-lg">info</span>
                <h2 class="text-sm font-semibold text-text-secondary uppercase tracking-wide">Thông Tin Chung</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5 ml-1">Mã Phiếu</label>
                    <div class="">
                        <input
                            class="block w-full rounded-lg border-gray-300 bg-gray-100 text-gray-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm font-mono cursor-not-allowed h-11 px-4"
                            readonly="" type="text" value="STK-20231027-0042" />
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5 ml-1">Ngày Kiểm Kê</label>
                    <div class="">
                        <input id="inventoryDate"
                            class="block w-full rounded-lg border-gray-300 bg-gray-50 text-gray-700 shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-11 px-4 cursor-not-allowed"
                            readonly type="date" />
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col h-[600px] overflow-hidden">
            <div
                class="p-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4 bg-white z-10">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-[#88636f] dark:text-[#bcaaa5] uppercase tracking-wide">Danh
                        Sách Tài Sản</h2>
                    <span id="totalAssetsBadge"
                        class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full font-medium ml-2">...
                        Mục</span>
                </div>
                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <div class="relative w-full sm:w-72">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-gray-400">search</span>
                        </div>
                        <input id="searchInput" oninput="handleSearch(this)"
                            class="block w-full pl-10 rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2"
                            placeholder="Tìm kiếm tài sản..." type="text" />
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-auto scrollbar-default relative">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm ring-1 ring-gray-900/5">
                        <tr>

                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 tracking-wider bg-slate-50">
                                Mã TS</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 tracking-wider bg-slate-50">
                                Tên Tài Sản</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 tracking-wider bg-slate-50">
                                Danh Mục</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase text-right border-b border-slate-200 bg-slate-100/70 tracking-wider w-32 border-l border-slate-200">
                                SL Sổ Sách</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase text-right border-b border-slate-200 tracking-wider w-36">
                                SL Thực Tế</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase text-center border-b border-slate-200 tracking-wider bg-slate-50 w-24">
                                Chi Tiết</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase text-right border-b border-slate-200 tracking-wider w-32">
                                Chênh Lệch</th>
                        </tr>
                    </thead>
                    <tbody id="assetTableBody" class="divide-y divide-slate-100 bg-white">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
            <div class="px-6 py-3 border-t border-gray-200 flex items-center justify-between bg-gray-50">
                <p class="text-xs text-[#88636f] dark:text-[#bcaaa5]" id="pagingInfo">Hiển thị <span
                        class="font-semibold text-gray-800">0-0</span>
                    trên
                    <span class="font-semibold text-gray-800">0</span> tài sản
                </p>
                <div class="flex gap-2">
                    <button id="btnPrev" onclick="changePage(-1)"
                        class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 transition-colors shadow-sm"
                        disabled="">Trước</button>
                    <button id="btnNext" onclick="changePage(1)"
                        class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 transition-colors shadow-sm">Tiếp</button>
                </div>
            </div>
        </div>
    </div>
    <div
        class="flex-none px-8 py-6 border-t border-[#e5dcdf] dark:border-[#4a3b40] bg-[#fcfcfc] dark:bg-[#251a1e] flex items-center justify-between z-20">
        <div class="flex items-center gap-6 text-sm">
            <div class="flex items-center gap-2">
                <span class="text-[#88636f] dark:text-[#bcaaa5] font-medium">Tiến độ:</span>
                <div class="w-32 h-2.5 bg-gray-100 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-primary rounded-full transition-all duration-300"
                        style="width: 0%"></div>
                </div>
                <span id="progressText" class="font-bold text-gray-900 ml-1">0%</span>
            </div>
            <div class="h-4 w-px bg-gray-200"></div>

        </div>
        <div class="flex gap-4">
            <button onclick="if(window.javaBridge) window.javaBridge.closeWindow()"
                class="px-6 py-2.5 rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] text-[#181113] dark:text-white text-sm font-medium hover:bg-[#f4f0f2] dark:hover:bg-[#35262b] transition-colors focus:outline-none focus:ring-2 focus:ring-[#e5dcdf] shadow-sm">
                Hủy Bỏ
            </button>
            <button id="btnComplete" onclick="completeStocktake()"
                class="px-6 py-2.5 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-[#2a1d21] shadow-md flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px]">check_circle</span>
                Hoàn Tất Kiểm Kê
            </button>
        </div>
    </div>
    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="closeDetailsModal()">
        </div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl flex flex-col transform transition-all scale-100 max-h-[85vh]">
                <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Chi Tiết Tài Sản</h3>
                        <p class="text-sm text-gray-500" id="detailsModalTitle">...</p>
                    </div>
                    <button onclick="closeDetailsModal()"
                        class="text-gray-500 hover:text-gray-900 dark:hover:text-white p-1 rounded-full hover:bg-gray-100">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="p-0 flex-1 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                            <tr>
                                <th class="p-3 text-xs font-semibold text-gray-500 uppercase">Tên Sản Phẩm</th>
                                <th class="p-3 text-xs font-semibold text-gray-500 uppercase">Serial</th>
                                <th class="p-3 text-xs font-semibold text-gray-500 uppercase text-center w-32">Tình
                                    Trạng</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody" class="divide-y divide-gray-100 dark:divide-gray-700">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
                <div
                    class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3 bg-gray-50 dark:bg-gray-800 rounded-b-xl">
                    <!-- Status Legend -->
                    <div class="flex-1 flex items-center gap-4 text-xs text-gray-500">
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 rounded-full bg-emerald-500"></div>Có mặt
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>Thiếu
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>Hỏng
                        </div>
                    </div>
                    <button onclick="closeDetailsModal()"
                        class="px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium text-sm shadow-sm">Hủy</button>
                    <button onclick="saveDetails()"
                        class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary-hover font-medium text-sm shadow-md">Xác
                        Nhận</button>
                </div>
            </div>
        </div>
    </div>
    <script src="icons.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Initialize Date
            try {
                const dateInput = document.getElementById('inventoryDate');
                if (dateInput) {
                    if (!dateInput.value) {
                        const now = new Date();
                        const yyyy = now.getFullYear();
                        const mm = String(now.getMonth() + 1).padStart(2, '0');
                        const dd = String(now.getDate()).padStart(2, '0');
                        dateInput.value = `${yyyy}-${mm}-${dd}`;
                    }
                }
            } catch (e) {
                console.error("Error setting date: " + e.message);
            }

            loadAssets();
        });

        let allAssets = [];
        let currentAssets = []; // Filtered list
        let stocktakeDetails = {}; // { assetId: [items...] }
        let stocktakeValues = {}; // { assetId: actualQuantity }
        let currentPage = 1;
        const itemsPerPage = 10;

        function loadAssets(retryCount = 0) {
            if (window.javaBridge && window.javaBridge.getAssets) {
                try {
                    const json = window.javaBridge.getAssets();
                    allAssets = JSON.parse(json);
                    currentAssets = [...allAssets]; // Default filter = all
                    renderTable();
                } catch (e) {
                    console.error("Error loading assets:", e);
                }
            } else {
                if (retryCount < 50) {
                    setTimeout(() => loadAssets(retryCount + 1), 100);
                }
            }
        }

        function renderTable() {
            const tbody = document.getElementById('assetTableBody');
            tbody.innerHTML = '';

            // Update badge (shows total filtered)
            document.getElementById('totalAssetsBadge').textContent = currentAssets.length + " Mục";

            // Pagination Logic
            const totalPages = Math.ceil(currentAssets.length / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, currentAssets.length);
            const displayAssets = currentAssets.slice(startIndex, endIndex);

            // Update Pagination UI
            const pagingInfo = document.getElementById('pagingInfo');
            if (pagingInfo) {
                pagingInfo.innerHTML = `Hiển thị <span class="font-semibold text-gray-800">${currentAssets.length > 0 ? startIndex + 1 : 0}-${endIndex}</span> trên <span class="font-semibold text-gray-800">${currentAssets.length}</span> tài sản`;
            }
            const btnPrev = document.getElementById('btnPrev');
            if (btnPrev) btnPrev.disabled = currentPage === 1;
            const btnNext = document.getElementById('btnNext');
            if (btnNext) btnNext.disabled = currentPage === totalPages;

            if (displayAssets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Không tìm thấy tài sản nào.</td></tr>';
                return;
            }

            displayAssets.forEach(asset => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group";
                tr.setAttribute('data-id', asset.id);

                let displayType = asset.asset_category;
                let isFixedAsset = false;
                if (displayType === 'TOOL') displayType = 'CCDC';
                if (displayType === 'FIXED_ASSET') {
                    displayType = 'TSCD';
                    isFixedAsset = true;
                }

                const stock = asset.current_stock || 0;

                // Retrieve stored value or Details count
                let actualVal = "";
                if (stocktakeDetails[asset.id]) {
                    actualVal = stocktakeDetails[asset.id].filter(i => i.status === 'FOUND' || i.status === 'DAMAGED').length;
                    // Sync with values
                    stocktakeValues[asset.id] = actualVal;
                } else if (stocktakeValues.hasOwnProperty(asset.id)) {
                    actualVal = stocktakeValues[asset.id];
                }

                // Input: Editable for both
                // Note: We pass 'asset.id' to calculateDiff to save value
                const inputHtml = `<input id="input-${asset.id}" oninput="calculateDiff(this, ${stock}, '${asset.id}')"
                        class="block w-full text-right rounded border-gray-300 py-1.5 text-sm focus:border-primary focus:ring-primary font-medium shadow-sm transition-colors"
                        type="number" value="${actualVal}" placeholder="Nhập SL" />`;

                // Details Link (Text style)
                const detailsHtml = isFixedAsset ?
                    `<a href="#" onclick="openDetails('${asset.id}', '${asset.name.replace(/'/g, "\\'")}')" 
                        class="text-primary hover:text-primary-hover hover:underline text-sm font-medium transition-colors">
                        Chi tiết
                    </a>`
                    :
                    `<span class="text-gray-300 text-center block">-</span>`;

                tr.innerHTML = `
                    <td class="p-4 align-middle text-xs font-mono text-gray-500">${asset.id}</td>
                    <td class="p-4 align-middle">
                        <span class="font-medium text-gray-900 text-sm">${asset.name}</span>
                    </td>
                    <td class="p-4 align-middle">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                            ${displayType}
                        </span>
                    </td>
                    <td class="p-4 align-middle text-right text-sm font-semibold text-gray-600 bg-gray-50/50 border-l border-gray-100">
                        ${stock}
                    </td>
                    <td class="p-4 align-middle">
                        ${inputHtml}
                    </td>
                     <td class="p-4 align-middle text-center">
                        ${detailsHtml}
                    </td>
                    <td class="p-4 align-middle text-right diff-cell">
                        <span class="text-slate-400 text-sm font-medium">-</span>
                    </td>
                `;
                tbody.appendChild(tr);

                if (actualVal !== "") {
                    const input = tr.querySelector('input[type="number"]');
                    // Pass false to avoid double progress update redundant calls during render
                    calculateDiff(input, stock, asset.id, false);
                }
            });

            updateProgress();
        }

        function changePage(delta) {
            currentPage += delta;
            renderTable();
        }

        function handleSearch(input) {
            const query = input.value.trim().toLowerCase();
            if (!query) {
                currentAssets = [...allAssets];
            } else {
                currentAssets = allAssets.filter(asset =>
                    asset.id.toLowerCase().includes(query) ||
                    asset.name.toLowerCase().includes(query)
                );
            }
            currentPage = 1; // Reset to first page
            renderTable();
        }

        // Details Logic
        let currentEditingAssetId = null;
        let currentAssetName = "";
        let bookItemsCache = {}; // { assetId: [ {id, serial, status, ...} ] }

        function openDetails(assetId, assetName) {
            const input = document.getElementById(`input-${assetId}`);
            const qtyVal = parseInt(input ? input.value : 0);

            if (!input || isNaN(qtyVal) || qtyVal <= 0) {
                alert("Vui lòng nhập Số lượng thực tế trước khi nhập chi tiết.");
                return;
            }

            currentEditingAssetId = assetId;
            currentAssetName = assetName;
            document.getElementById('detailsModalTitle').textContent = assetName;
            document.getElementById('detailsTableBody').innerHTML = '<tr><td colspan="4" class="p-4 text-center">Đang tải...</td></tr>';
            document.getElementById('detailsModal').classList.remove('hidden');

            // Fetch Book Items for Lookup
            if (!bookItemsCache[assetId]) {
                if (window.javaBridge) {
                    try {
                        const json = window.javaBridge.getStocktakeDetails(assetId);
                        bookItemsCache[assetId] = JSON.parse(json);
                    } catch (e) {
                        console.error(e);
                        bookItemsCache[assetId] = [];
                    }
                }
            }

            // Generate Rows based on Qty
            let currentRows = stocktakeDetails[assetId] || [];

            // Adjust size
            if (currentRows.length > qtyVal) {
                currentRows = currentRows.slice(0, qtyVal);
            } else {
                while (currentRows.length < qtyVal) {
                    currentRows.push({ id: null, newSerial: "", status: "" });
                }
            }
            stocktakeDetails[assetId] = currentRows;

            renderDetailsTable(currentRows);
        }

        function renderDetailsTable(items) {
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            const bookItems = bookItemsCache[currentEditingAssetId] || [];

            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50";

                const serialVal = item.newSerial || "";
                const statusVal = item.status || "";

                // Check match
                let matchIcon = '';
                if (serialVal) {
                    const match = bookItems.find(b => b.serial === serialVal);
                    if (match) {
                        item.id = match.id; // Resolve ID
                        matchIcon = `<span class="material-symbols-outlined text-emerald-600 text-[18px]" title="Đã khớp dữ liệu hệ thống">link</span>`;
                    } else {
                        item.id = null;
                        matchIcon = `<span class="material-symbols-outlined text-gray-400 text-[18px]" title="Chưa khớp dữ liệu (Mới/Sai Serial)">link_off</span>`;
                    }
                }

                tr.innerHTML = `
                    <td class="p-3 text-sm text-gray-800 font-medium">${currentAssetName} #${index + 1}</td>
                    <td class="p-3 relative">
                        <div class="flex items-center gap-2">
                            <input type="text" 
                                class="block w-full rounded border-gray-300 py-1 px-2 text-sm focus:border-primary focus:ring-primary shadow-sm"
                                placeholder="Nhập Serial..."
                                value="${serialVal}"
                                oninput="updateItemDetails(${index}, 'newSerial', this.value)"
                            />
                            <div class="match-icon-placeholder w-6 flex justify-center">${matchIcon}</div>
                        </div>
                    </td>
                    <td class="p-3 text-center">
                        <select onchange="updateItemDetails(${index}, 'status', this.value)"
                            class="block w-full rounded border-gray-300 py-1 pl-2 pr-8 text-sm focus:border-primary focus:ring-primary shadow-sm cursor-pointer ml-auto
                            ${statusVal === 'FOUND' ? 'text-emerald-700 font-medium bg-emerald-50' : (statusVal === 'DAMAGED' ? 'text-orange-700 font-medium bg-orange-50' : 'text-gray-500')}">
                            <option value="" ${statusVal === "" ? "selected" : ""}>- Chọn -</option>
                            <option value="FOUND" ${statusVal === "FOUND" ? "selected" : ""} class="text-emerald-700">Tốt</option>
                            <option value="DAMAGED" ${statusVal === "DAMAGED" ? "selected" : ""} class="text-orange-700">Hỏng</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateItemDetails(index, field, value) {
            if (!currentEditingAssetId || !stocktakeDetails[currentEditingAssetId]) return;
            const item = stocktakeDetails[currentEditingAssetId][index];
            if (item) {
                item[field] = value;
                if (field === 'newSerial') {
                    const bookItems = bookItemsCache[currentEditingAssetId] || [];
                    const match = bookItems.find(b => b.serial === value);
                    item.id = match ? match.id : null;

                    // Direct DOM update to prevent focus loss
                    const tbody = document.getElementById('detailsTableBody');
                    if (tbody && tbody.children[index]) {
                        const matchContainer = tbody.children[index].querySelector('.match-icon-placeholder');
                        if (matchContainer) {
                            if (match) {
                                matchContainer.innerHTML = `<span class="material-symbols-outlined text-emerald-600 text-[18px]" title="Đã khớp dữ liệu hệ thống">link</span>`;
                            } else if (value) {
                                matchContainer.innerHTML = `<span class="material-symbols-outlined text-gray-400 text-[18px]" title="Chưa khớp dữ liệu (Mới/Sai Serial)">link_off</span>`;
                            } else {
                                matchContainer.innerHTML = '';
                            }
                        }
                    }
                } else if (field === 'status') {
                    renderDetailsTable(stocktakeDetails[currentEditingAssetId]);
                }
            }
        }

        function saveDetails() {
            if (!currentEditingAssetId) return;

            const items = stocktakeDetails[currentEditingAssetId];
            const presentCount = items.filter(i => i.status === 'FOUND' || i.status === 'DAMAGED').length;

            // Save to data model - This marks as confirmed/done
            stocktakeValues[currentEditingAssetId] = presentCount;

            // Update UI
            const input = document.getElementById(`input-${currentEditingAssetId}`);
            if (input) {
                // Let's NOT change input value automatically. Let user decide.
                // But `calculateDiff` needs to know if "Confirmed".
                // Let's pass `isConfirmed = true`.
                calculateDiff(input, parseInt(input.closest('tr').cells[3].textContent.trim()) || 0, currentEditingAssetId, true, true);
            } else {
                updateProgress();
            }

            closeDetailsModal();
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            currentEditingAssetId = null;
        }

        function calculateDiff(input, stock, assetId, doUpdateProgress = true, isConfirmed = false) {
            const row = input.closest('tr');
            const diffCell = row.querySelector('.diff-cell');
            const val = parseInt(input.value);

            // Logic: Update stocktakeValues (Progress) only if:
            // 1. Tool (always)
            // 2. Fixed Asset AND isConfirmed (via Save Details)
            let shouldSave = false;
            let isFixed = false;

            const asset = allAssets.find(a => a.id === assetId);
            if (asset) {
                if (asset.asset_category === 'TOOL' || asset.asset_category.includes('TOOL')) {
                    shouldSave = true;
                } else {
                    isFixed = true;
                    if (isConfirmed) shouldSave = true;
                }
            }

            if (shouldSave) {
                if (!isNaN(val)) {
                    stocktakeValues[assetId] = val;
                } else {
                    delete stocktakeValues[assetId];
                }
            } else if (isFixed && !isConfirmed) {
                // For FA, if not confirmed, ensure we don't accidentally set it?
                // Actually stocktakeValues is set by saveDetails explicitly.
                // But calculateDiff shouldn't DELETE it if I just type?
                // If I type, `stocktakeValues` might be old.
                // Actually, if I type 5 (but saved was 3), `stocktakeValues` remains 3.
                // Progress remains based on 3.
                // Visual Diff updates based on 5.
                // This seems correct for "Progress based on Done".
            }

            if (doUpdateProgress) updateProgress();

            let baseClass = "block w-full text-right rounded py-1.5 text-sm font-medium shadow-sm transition-colors border-gray-300 focus:border-primary focus:ring-primary ";

            if (isNaN(val)) {
                diffCell.innerHTML = '<span class="text-slate-400 text-sm font-medium">-</span>';
                input.className = baseClass + "text-gray-700";
                return;
            }

            const diff = val - stock;
            let html = '';

            if (diff === 0) {
                html = `
                    <span class="inline-flex items-center justify-end gap-1 text-sm font-bold text-emerald-600 w-full opacity-40">
                        0 <span class="material-symbols-outlined text-base">check</span>
                    </span>`;
                input.className = baseClass + "text-slate-600";
            } else if (diff > 0) {
                html = `
                    <span class="inline-flex items-center justify-end gap-1 text-sm font-bold text-emerald-600 w-full">
                        +${diff} <span class="material-symbols-outlined text-base">arrow_drop_up</span>
                    </span>`;
                input.className = baseClass + "text-emerald-700 font-bold";
            } else {
                html = `
                    <span class="inline-flex items-center justify-end gap-1 text-sm font-bold text-red-600 w-full">
                        ${diff} <span class="material-symbols-outlined text-base">arrow_drop_down</span>
                    </span>`;
                input.className = baseClass + "text-red-700 font-bold";
            }

            diffCell.innerHTML = html;
        }

        function updateProgress() {
            if (allAssets.length === 0) return;
            const count = Object.keys(stocktakeValues).length;
            const percent = Math.round((count / allAssets.length) * 100);

            const bar = document.getElementById('progressBar');
            if (bar) bar.style.width = percent + "%";

            const txt = document.getElementById('progressText');
            if (txt) txt.textContent = percent + "%";
        }

        function completeStocktake() {
            if (!window.javaBridge) {
                alert("Lỗi kết nối tới hệ thống (Java Bridge not found).");
                return;
            }

            const data = [];

            // Iterate ALL assets, not just rows
            allAssets.forEach(asset => {
                const id = asset.id;
                const stock = asset.current_stock || 0;

                // Check if we have an actual value input
                if (stocktakeValues.hasOwnProperty(id)) {
                    const actual = parseInt(stocktakeValues[id]);
                    let type = "UNKNOWN";
                    if (asset.asset_category === 'TOOL' || asset.asset_category.includes("TOOL")) type = 'TOOL';
                    if (asset.asset_category === 'FIXED_ASSET' || asset.asset_category.includes("FIXED") || asset.asset_category.includes("TSCD")) type = 'FIXED_ASSET';

                    if (type === "FIXED_ASSET") {
                        // Must have details if saved
                        if (stocktakeDetails[id]) {
                            data.push({
                                id: id,
                                name: asset.name,
                                asset_category: asset.asset_category,
                                base_unit: asset.base_unit,
                                type: type,
                                stock: stock,
                                actual: actual,
                                items: stocktakeDetails[id]
                            });
                        }
                    } else {
                        // Tool
                        data.push({
                            id: id,
                            name: asset.name,
                            asset_category: asset.asset_category,
                            base_unit: asset.base_unit,
                            type: type,
                            stock: stock,
                            actual: actual
                        });
                    }
                }
            });

            if (data.length === 0) {
                alert("Không có thay đổi nào để lưu. Vui lòng nhập số lượng kiểm kê.");
                return;
            }

            const btn = document.getElementById('btnComplete');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined text-[20px] animate-spin">refresh</span> Đang lưu...';
            btn.disabled = true;

            setTimeout(() => {
                try {
                    const jsonStr = JSON.stringify(data);
                    const result = window.javaBridge.completeStocktakeAndExport(jsonStr);

                    if (result && result.startsWith("SUCCESS")) {
                        const filePath = result.split("|")[1];
                        alert("Đã lưu kết quả kiểm kê và xuất file Excel thành công!\n\nFile được lưu tại: " + filePath);
                        // Simple page reload to reset state
                        window.location.reload();

                        if (window.javaBridge.closeWindow) {
                            window.javaBridge.closeWindow();
                        }
                    } else {
                        alert("Có lỗi xảy ra: " + result);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Lỗi khi gọi Java: " + e.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }, 100);
        }
    </script>
</body>

</html>