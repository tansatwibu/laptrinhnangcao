<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Cửa Sổ Báo Hỏng</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#c71551",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211116",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e5dcdf;
            border-radius: 20px;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <div
        class="flex items-center justify-between px-8 py-6 border-b border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#2a1d21]">
        <div class="flex flex-col gap-1">
            <h1 class="text-[#181113] dark:text-white text-2xl font-bold leading-tight">Báo Cáo Hư Hỏng</h1>
            <p class="text-[#88636f] dark:text-[#bcaaa5] text-sm font-normal">Ghi nhận tài sản hư hỏng và lý do thanh
                lý.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
        <div class="max-w-[1400px] mx-auto w-full flex flex-col gap-8">

            <!-- Information Section -->
            <div class="flex flex-col gap-4">
                <h2 class="text-[#181113] dark:text-white text-lg font-semibold border-l-4 border-primary pl-3">
                    Thông Tin Chung
                </h2>
                <div
                    class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-[#fcfcfc] dark:bg-[#251a1e] p-6 rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40]">
                    <label class="flex flex-col flex-1 group">
                        <span class="text-[#181113] dark:text-white text-sm font-medium leading-normal pb-2">Ngày Báo
                            Cáo</span>
                        <div class="relative">
                            <input id="report-date"
                                class="w-full rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] text-[#181113] dark:text-white h-11 px-4 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-shadow text-sm"
                                type="date" />
                        </div>
                    </label>
                    <label class="flex flex-col flex-1 group">
                        <span
                            class="text-[#181113] dark:text-white text-sm font-medium leading-normal pb-2">Khoa/Phòng</span>
                        <div class="relative">
                            <select id="departmentSelect"
                                class="w-full appearance-none rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] text-[#181113] dark:text-white h-11 pl-4 pr-10 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-shadow text-sm cursor-pointer">
                                <option value="" disabled selected>Chọn khoa/phòng...</option>
                            </select>
                            <span
                                class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-[#88636f] pointer-events-none text-[20px]">expand_more</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Assets Section -->
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-[#181113] dark:text-white text-lg font-semibold border-l-4 border-primary pl-3">
                        Tài Sản Bị Ảnh Hưởng
                    </h2>
                    <div class="relative w-72">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#88636f] text-[20px]">search</span>
                        <input id="searchAssetInput"
                            class="w-full pl-10 pr-4 h-10 rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] text-[#181113] dark:text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none placeholder:text-[#88636f] transition-shadow"
                            placeholder="Tìm theo mã hoặc tên..." type="text" />
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-[#251a1e] rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] shadow-sm overflow-hidden flex flex-col h-[400px]">
                    <div class="overflow-auto custom-scrollbar flex-1">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-[#fcfcfc] dark:bg-[#2a1d21] sticky top-0 z-10">
                                <tr>
                                    <th
                                        class="p-4 text-xs font-semibold text-[#88636f] dark:text-[#bcaaa5] uppercase tracking-wider border-b border-[#e5dcdf] dark:border-[#4a3b40]">
                                        Thông Tin Tài Sản</th>
                                    <th
                                        class="p-4 text-xs font-semibold text-[#88636f] dark:text-[#bcaaa5] uppercase tracking-wider border-b border-[#e5dcdf] dark:border-[#4a3b40] text-right">
                                        Đã bàn giao</th>
                                    <th
                                        class="p-4 text-xs font-semibold text-[#88636f] dark:text-[#bcaaa5] uppercase tracking-wider border-b border-[#e5dcdf] dark:border-[#4a3b40] w-36">
                                        SL Hỏng</th>
                                    <th
                                        class="p-4 text-xs font-semibold text-[#88636f] dark:text-[#bcaaa5] uppercase tracking-wider border-b border-[#e5dcdf] dark:border-[#4a3b40]">
                                        Chi Tiết</th>
                                    <th
                                        class="p-4 text-xs font-semibold text-[#88636f] dark:text-[#bcaaa5] uppercase tracking-wider border-b border-[#e5dcdf] dark:border-[#4a3b40] w-52">
                                        Lý Do</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#e5dcdf] dark:divide-[#4a3b40]" id="assetTableBody">
                                <!-- Rows will be added by JS -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination (Simplified) -->
                    <div
                        class="px-6 py-4 border-t border-[#e5dcdf] dark:border-[#4a3b40] bg-[#fcfcfc] dark:bg-[#2a1d21] flex items-center justify-between text-xs text-[#88636f]">
                        <span>Hiển thị <span class="font-medium text-[#181113] dark:text-white">2</span> trên <span
                                class="font-medium text-[#181113] dark:text-white">124</span> tài sản</span>
                        <div class="flex gap-2">
                            <button
                                class="px-3 py-1.5 rounded border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] text-[#181113] dark:text-white hover:bg-[#f4f0f2] transition-colors disabled:opacity-50">Trước</button>
                            <button
                                class="px-3 py-1.5 rounded border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] text-[#181113] dark:text-white hover:bg-[#f4f0f2] transition-colors">Tiếp</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div
        class="flex items-center justify-between px-8 py-6 bg-[#fcfcfc] dark:bg-[#251a1e] border-t border-[#e5dcdf] dark:border-[#4a3b40]">
        <div class="flex items-center gap-4">
            <button
                class="px-6 py-2.5 rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] text-[#181113] dark:text-white text-sm font-medium hover:bg-[#f4f0f2] dark:hover:bg-[#35262b] transition-colors focus:outline-none focus:ring-2 focus:ring-[#e5dcdf] shadow-sm">
                Hủy Bỏ
            </button>
            <button onclick="submitReport()"
                class="px-6 py-2.5 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-[#2a1d21] shadow-md">
                Xác Nhận
            </button>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-sm text-[#88636f]">Tổng Mục Báo Hỏng:</span>
            <span
                class="inline-flex items-center justify-center bg-red-50 text-primary px-2.5 py-0.5 rounded-full text-xs font-bold border border-red-100">1</span>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-[#251a1e] rounded-xl shadow-xl w-[500px] max-h-[80vh] flex flex-col">
            <div
                class="p-6 border-b border-[#e5dcdf] dark:border-[#4a3b40] flex justify-between items-center bg-[#fcfcfc] dark:bg-[#2a1d21] rounded-t-xl">
                <h3 class="text-lg font-bold text-[#181113] dark:text-white">Chi tiết báo hỏng</h3>
                <button onclick="closeDetailModal()"
                    class="text-[#88636f] hover:text-[#181113] dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <p class="text-sm text-[#88636f] mb-4">Nhập ID/Serial của <span id="modalAssetName"
                        class="font-medium text-[#181113] dark:text-white"></span> bị hỏng:</p>
                <div id="modalItemsContainer" class="space-y-3">
                    <!-- Dynamic Inputs -->
                </div>
            </div>

            <div
                class="p-6 border-t border-[#e5dcdf] dark:border-[#4a3b40] flex justify-end gap-3 bg-[#fcfcfc] dark:bg-[#2a1d21] rounded-b-xl">
                <button onclick="closeDetailModal()"
                    class="px-4 py-2 rounded-lg border border-[#e5dcdf] dark:border-[#4a3b40] text-[#181113] dark:text-white text-sm font-medium hover:bg-[#f4f0f2] dark:hover:bg-[#35262b] transition-colors">
                    Hủy
                </button>
                <button onclick="saveDetails()"
                    class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary/90 transition-colors shadow-md">
                    Lưu
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentDetailRow = null;
        let currentRowDetails = [];

        function openDetailModal(el, assetId, assetName, maxQty) {
            const row = el.closest('tr');
            const qtyInput = row.querySelector('input[data-field="qty"]');
            const qty = parseInt(qtyInput.value) || 0;

            if (qty <= 0) {
                alert("Vui lòng nhập số lượng hỏng trước khi nhập chi tiết.");
                return;
            }

            currentDetailRow = row;
            document.getElementById('detailModal').classList.remove('hidden');
            document.getElementById('detailModal').classList.add('flex');
            document.getElementById('modalAssetName').textContent = assetName;

            const container = document.getElementById('modalItemsContainer');
            container.innerHTML = '';

            // Generate inputs based on Quantity
            const existingDetailsJson = row.querySelector('.detail-data').value;
            const existingDetails = existingDetailsJson ? JSON.parse(existingDetailsJson) : [];

            for (let i = 0; i < qty; i++) {
                const val = existingDetails[i] || '';
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-[#88636f] w-8 pt-2 text-right">#${i + 1}</span>
                        <input class="flex-1 h-9 rounded border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] px-3 text-sm text-[#181113] dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none detail-input"
                            type="text" placeholder="Nhập ID/Serial..." value="${val}" />
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            document.getElementById('detailModal').classList.remove('flex');
            currentDetailRow = null;
        }

        function saveDetails() {
            if (!currentDetailRow) return;

            const inputs = document.querySelectorAll('.detail-input');
            const details = [];
            let allFilled = true;

            inputs.forEach(input => {
                const val = input.value.trim();
                if (!val) allFilled = false;
                details.push(val);
            });

            if (!allFilled) {
                alert("Vui lòng nhập đầy đủ chi tiết cho tất cả các mục.");
                return;
            }

            // Save to hidden input
            currentDetailRow.querySelector('.detail-data').value = JSON.stringify(details);

            // Update link text
            const link = currentDetailRow.querySelector('.detail-link');
            link.textContent = `Đã nhập (${details.length})`;
            link.classList.remove('text-red-500');
            link.classList.add('text-green-600');

            closeDetailModal();
        }

        document.addEventListener('DOMContentLoaded', function () {
            // ... existing listeners ...

            const dateInput = document.getElementById('report-date');
            if (dateInput) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
            const searchInput = document.getElementById('searchAssetInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterAssets);
            }
        });

        function filterAssets() {
            const query = document.getElementById('searchAssetInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#assetTableBody tr');

            rows.forEach(row => {
                // If it's the "No assets" row
                if (row.cells.length === 1 && row.cells[0].colSpan === 6) return;

                const nameEl = row.querySelector('.font-medium');
                const idEl = row.querySelector('.font-mono');

                const name = nameEl ? nameEl.textContent.toLowerCase() : '';
                const id = idEl ? idEl.textContent.toLowerCase() : '';

                if (name.includes(query) || id.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function initData() {
            if (window.javaBridge && window.javaBridge.getDepartments) {
                try {
                    const depts = JSON.parse(window.javaBridge.getDepartments());
                    const select = document.getElementById('departmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="" disabled selected>Chọn khoa/phòng...</option>';
                        depts.forEach(d => {
                            const opt = document.createElement('option');
                            opt.value = d.id;
                            opt.textContent = d.name;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', function () {
                            const deptId = this.value;
                            loadAssetsForDepartment(deptId);
                        });
                    }
                } catch (e) {
                    console.error("Error loading departments", e);
                }
            } else {
                console.warn("window.javaBridge.getDepartments not available");
            }
        }

        function loadAssetsForDepartment(deptId) {
            try {
                const assets = JSON.parse(window.javaBridge.getAssetsByDepartment(deptId));
                const tbody = document.getElementById('assetTableBody');
                tbody.innerHTML = '';

                if (assets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-[#88636f]">Không có tài sản nào trong khoa/phòng này.</td></tr>';
                    return;
                }

                assets.forEach(asset => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-[#fff0f5] dark:hover:bg-[#35262b] transition-colors group';

                    row.innerHTML = `
                        <td class="p-4">
                            <div class="flex flex-col">
                                <span class="font-medium text-[#181113] dark:text-white">${asset.name}</span>
                                <span class="text-xs text-[#88636f] font-mono mt-0.5">${asset.id}</span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-medium text-[#181113] dark:text-white">${asset.quantity}</td>
                        <td class="p-4">
                            <input class="w-full h-9 rounded border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] px-3 text-right text-sm text-[#181113] dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none"
                                type="number" min="0" max="${asset.quantity}" placeholder="0" data-field="qty" />
                        </td>
                        <td class="p-4">
                            ${(asset.category === 'TSCD' || asset.category === 'FIXED_ASSET')
                            ? `<a href="#" class="text-primary hover:text-primary/80 text-sm font-medium detail-link" onclick="openDetailModal(this, '${asset.id}', '${asset.name}', ${asset.quantity}); return false;">Nhập chi tiết</a>`
                            : '<span class="text-[#88636f] text-sm">-</span>'}
                            <input type="hidden" class="detail-data" value="" />
                        </td>
                        <td class="p-4">
                            <div class="relative">
                                <select class="w-full h-9 rounded border border-[#e5dcdf] dark:border-[#4a3b40] bg-white dark:bg-[#35262b] pl-3 pr-8 text-sm text-[#181113] dark:text-white focus:border-primary focus:ring-1 focus:ring-primary appearance-none outline-none cursor-pointer" data-field="reason">
                                    <option disabled selected>Chọn lý do...</option>
                                    <option value="Hỏng">Vỡ / Hỏng</option>
                                    <option value="Lỗi Kỹ Thuật">Lỗi Kỹ Thuật</option>
                                    <option value="Hết Hạn">Hết Hạn</option>
                                    <option value="Mất">Mất</option>
                                </select>
                                <span class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-[#88636f] pointer-events-none text-[18px]">expand_more</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                // Re-apply icons if needed, but we use Material Symbols font so innerHTML is fine if text is correct.
            } catch (e) {
                console.error("Error loading assets for department", e);
            }
        }

        function submitReport() {
            const deptSelect = document.getElementById('departmentSelect');
            const deptId = deptSelect.value;
            if (!deptId) {
                alert("Vui lòng chọn Khoa/Phòng.");
                return;
            }

            const rows = document.querySelectorAll('#assetTableBody tr');
            const items = [];

            let hasError = false;

            rows.forEach(row => {
                const qtyInput = row.querySelector('input[data-field="qty"]');
                const reasonSelect = row.querySelector('select[data-field="reason"]');
                const idEl = row.querySelector('.font-mono');

                if (!qtyInput || !idEl) return;

                const qty = parseInt(qtyInput.value) || 0;
                const id = idEl.textContent;
                const reason = reasonSelect.value; // "Chọn lý do..." is the default value text or disabled value

                if (qty > 0) {
                    if (reason === "Chọn lý do...") {
                        hasError = true;
                        reasonSelect.classList.add('border-red-500');
                        reasonSelect.addEventListener('change', function () {
                            this.classList.remove('border-red-500');
                        }, { once: true });
                    }

                    // Check Details for TSCD
                    const detailLink = row.querySelector('.detail-link');
                    if (detailLink) { // Exists only for TSCD
                        const detailData = row.querySelector('.detail-data').value;
                        let details = [];
                        try {
                            details = JSON.parse(detailData);
                        } catch (e) { }

                        // Validate count match
                        if (details.length !== qty) {
                            hasError = true;
                            detailLink.classList.remove('text-primary', 'text-green-600');
                            detailLink.classList.add('text-red-500');
                            detailLink.textContent = "Chưa nhập đủ!";
                        }
                        // Also include details in item payload
                        items.push({ id, qty, reason, details });
                    } else {
                        items.push({ id, qty, reason });
                    }
                }
            });

            if (hasError) {
                alert("Vui lòng chọn lý do cho các tài sản báo hỏng.");
                return;
            }

            if (items.length === 0) {
                alert("Vui lòng nhập số lượng hỏng cho ít nhất một tài sản.");
                return;
            }

            const payload = {
                departmentId: deptId,
                items: items
            };

            console.log("Submitting:", payload);

            if (window.javaBridge && window.javaBridge.submitDamageReport) {
                try {
                    window.javaBridge.submitDamageReport(JSON.stringify(payload));
                    alert("Đã gửi báo cáo hư hỏng thành công!");
                    // Refresh data
                    loadAssetsForDepartment(deptId);
                } catch (e) {
                    console.error("Error submitting report", e);
                    alert("Lỗi khi gửi báo cáo: " + e.message);
                }
            } else {
                console.warn("window.javaBridge.submitDamageReport not available");
                alert("Không thể kết nối tới ứng dụng.");
            }
        }
    </script>
    <script src="icons.js"></script>
</body>

</html>